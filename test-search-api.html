<!DOCTYPE html>
<html>
<head>
    <title>Test Web Search API</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2563eb; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input { padding: 8px; width: 400px; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç Web Search API Test</h1>
    
    <div class="test info">
        <h3>Test Configuration</h3>
        <label>Perplexity API Key:</label><br>
        <input type="password" id="apiKey" placeholder="Enter your Perplexity API key (pplx-...)" style="width: 500px;"><br><br>
        <label>Test Query:</label><br>
        <input type="text" id="testQuery" value="Python dependency management best practices" style="width: 500px;"><br><br>
        <button onclick="testDirectCall()">Test Direct API Call</button>
        <button onclick="testEndpoint()">Test /api/search Endpoint</button>
    </div>

    <div id="results"></div>

    <script>
        async function testDirectCall() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const query = document.getElementById('testQuery').value.trim();
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="test info">Testing direct Perplexity API call...</div>';
            
            try {
                const response = await fetch("https://api.perplexity.ai/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "sonar",
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful research assistant. Provide concise, factual information with citations."
                            },
                            {
                                role: "user",
                                content: query
                            }
                        ],
                        temperature: 0.2,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                
                // Extract citations
                let citations = [];
                if (data.citations && Array.isArray(data.citations)) {
                    citations = data.citations;
                } else if (data.search_results && Array.isArray(data.search_results)) {
                    citations = data.search_results.map(r => r.url || r.link).filter(Boolean);
                } else if (data.choices[0]?.message?.citations && Array.isArray(data.choices[0].message.citations)) {
                    citations = data.choices[0].message.citations;
                }

                const content = data.choices[0]?.message?.content || 'No content';
                
                resultsDiv.innerHTML = `
                    <div class="test success">
                        <h3>‚úÖ Direct API Call Success</h3>
                        <p><strong>Query:</strong> ${query}</p>
                        <p><strong>Citations Found:</strong> ${citations.length}</p>
                        <p><strong>Response Structure:</strong></p>
                        <pre>${JSON.stringify({
                            has_citations: !!data.citations,
                            has_search_results: !!data.search_results,
                            has_message_citations: !!data.choices[0]?.message?.citations,
                            citations_count: citations.length,
                            citations: citations.slice(0, 5),
                            content_length: content.length,
                            content_preview: content.substring(0, 200) + '...'
                        }, null, 2)}</pre>
                        <p><strong>Full Response Keys:</strong> ${Object.keys(data).join(', ')}</p>
                        ${citations.length > 0 ? `<p><strong>Sample Citations:</strong></p><ul>${citations.slice(0, 3).map(c => `<li>${c}</li>`).join('')}</ul>` : ''}
                    </div>
                `;
            } catch (err) {
                resultsDiv.innerHTML = `
                    <div class="test error">
                        <h3>‚ùå Direct API Call Failed</h3>
                        <p><strong>Error:</strong> ${err.message}</p>
                        <p>This might be a CORS issue if running from file://. Try testing the endpoint instead.</p>
                    </div>
                `;
            }
        }

        async function testEndpoint() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const query = document.getElementById('testQuery').value.trim();
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="test info">Testing /api/search endpoint...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        searchApiKey: apiKey
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || `Endpoint error: ${response.status}`);
                }

                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="test success">
                        <h3>‚úÖ /api/search Endpoint Success</h3>
                        <p><strong>Query:</strong> ${query}</p>
                        <p><strong>Response Structure:</strong></p>
                        <pre>${JSON.stringify({
                            has_findings: !!data.findings,
                            has_sources: !!data.sources,
                            sources_count: data.sources?.length || 0,
                            has_key_points: !!data.key_points,
                            verified: data.verified,
                            findings_preview: data.findings?.substring(0, 200) + '...',
                            sources_preview: data.sources?.slice(0, 3)
                        }, null, 2)}</pre>
                        ${data.sources && data.sources.length > 0 ? `
                            <p><strong>Sources Found:</strong></p>
                            <ul>${data.sources.slice(0, 5).map(s => `
                                <li>
                                    <strong>${s.type}</strong> (score: ${s.authority_score})<br>
                                    ${s.url || 'No URL'}<br>
                                    <em>${s.key_info?.substring(0, 100)}</em>
                                </li>
                            `).join('')}</ul>
                        ` : ''}
                    </div>
                `;
            } catch (err) {
                resultsDiv.innerHTML = `
                    <div class="test error">
                        <h3>‚ùå /api/search Endpoint Failed</h3>
                        <p><strong>Error:</strong> ${err.message}</p>
                        <p>Make sure you're running this from a server (not file://) or that the endpoint is deployed.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

